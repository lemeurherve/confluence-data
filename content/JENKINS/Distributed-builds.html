<!DOCTYPE html>
<html>
    <head>
        <title>Jenkins : Distributed builds</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Jenkins</a></span>
                            </li>
                                                    <li>
                                <span><a href="Home.html">Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Use-Jenkins.html">Use Jenkins</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Jenkins : Distributed builds
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Unknown User (kohsuke)</span>, last modified by <span class='editor'> Unknown User (jsoref)</span> on May 09, 2019
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>It is pretty common when starting with Jenkins to have a single server which runs the master and all builds, however Jenkins architecture is fundamentally &quot;Master+Agent&quot;. The master is designed to do co-ordination and provide the GUI and API endpoints, and the Agents are designed to perform the work. The reason being that workloads are often best &quot;farmed out&quot; to distributed servers. This may be for scale, or to provide different tools, or build on different target platforms. Another common reason for remote agents is to enact deployments into secured environments (without the master having direct access). </p><p>Many people today use Jenkins in cloud environments, and there are plugins and extensions to support the various environments and clouds. These may involve Virtual Machines, Docker Containers, Kubernetes (for example see <a href="http://jenkins.io/projects/jenkins-x" class="external-link" rel="nofollow">Jenkins-X</a>), EC2, Azure, Google Cloud, VMWare and more. In these cases the agents are managed for you typically (and in many cases on demand, as needed), so you may not need to read the content of this document for those cases. </p><p>This document describes this distributed mode of Jenkins and some of the ways in which you can configure it, should you need to take control (or maybe you are curious)</p><p><br/></p><p><span style="color: rgb(210,73,57);">Contents</span></p><p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1631020104763 {padding: 0px;}
div.rbtoc1631020104763 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1631020104763 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1631020104763'>
<ul class='toc-indentation'>
<li><a href='#Distributedbuilds-Howdoesthiswork?'>How does this work?</a>
<ul class='toc-indentation'>
<li><a href='#Distributedbuilds-Mastertoagentconnections'>Master to agent connections</a></li>
<li><a href='#Distributedbuilds-Agenttomasterconnections'>Agent to master connections</a></li>
<li><a href='#Distributedbuilds-Choosingwhichagentpipelinesandstepsrunon'>Choosing which agent pipelines and steps run on</a></li>
</ul>
</li>
<li><a href='#Distributedbuilds-Differentwaysofstartingagents'>Different ways of starting agents</a>
<ul class='toc-indentation'>
<li><a href='#Distributedbuilds-Havemasterlaunchagentviassh'>Have master launch agent via ssh</a></li>
<li><a href='#Distributedbuilds-HavemasterlaunchagentonWindows'>Have master launch agent on Windows</a></li>
<li><a href='#Distributedbuilds-WriteyourownscripttolaunchJenkinsagents'>Write your own script to launch Jenkins agents</a></li>
<li><a href='#Distributedbuilds-Launchagentvia&quot;JNLP&quot;fromagentbacktomasterinabrowser'>Launch agent via &quot;JNLP&quot; from agent back to master in a browser</a></li>
<li><a href='#Distributedbuilds-Launchagentheadlesslyfromagentbacktomasteroncommandline'>Launch agent headlessly from agent back to master on command line</a></li>
<li><a href='#Distributedbuilds-OtherRequirements'>Other Requirements</a></li>
</ul>
</li>
<li><a href='#Distributedbuilds-Nodelabelsforagents'>Node labels for agents</a>
<ul class='toc-indentation'>
<li><a href='#Distributedbuilds-Defininglabels'>Defining labels</a></li>
<li><a href='#Distributedbuilds-Usinglabels'>Using labels</a></li>
</ul>
</li>
<li><a href='#Distributedbuilds-Example:ConfigurationonUnix'>Example: Configuration on Unix</a></li>
<li><a href='#Distributedbuilds-Schedulingstrategy'>Scheduling strategy</a></li>
<li><a href='#Distributedbuilds-Nodemonitoring'>Node monitoring</a></li>
<li><a href='#Distributedbuilds-Offlinestatusandretentionstrategy'>Offline status and retention strategy</a></li>
<li><a href='#Distributedbuilds-Transitionfrommaster-onlytomaster/agent'>Transition from master-only to master/agent</a></li>
<li><a href='#Distributedbuilds-AccessanInternalCIBuildFarm(Master+Agents)fromthePublicInternet'>Access an Internal CI Build Farm (Master + Agents) from the Public Internet</a></li>
<li><a href='#Distributedbuilds-RunningMultipleAgentsontheSameMachine'>Running Multiple Agents on the Same Machine</a></li>
<li><a href='#Distributedbuilds-Troubleshootingtips'>Troubleshooting tips</a>
<ul class='toc-indentation'>
<li><a href='#Distributedbuilds-Windowsagentserviceupgrades'>Windows agent service upgrades</a></li>
</ul>
</li>
<li><a href='#Distributedbuilds-Otherreadings'>Other readings</a></li>
</ul>
</div></p><h1 id="Distributedbuilds-Howdoesthiswork?">How does this work?</h1><p>A &quot;master&quot; operating by itself is the basic installation of Jenkins and in this configuration the master handles all tasks for your build system. In most cases installing an agent doesn't change the behavior of the master. It will serve all HTTP requests, and it can still build projects on its own. Once you install a few agents you might find yourself removing the executors on the master in order to free up master resources (allowing it to concentrate resources on managing your build environment) but this is not a necessary step. If you start to use Jenkins a lot with just a master you will most likely find that you will run out of resources (memory, CPU, etc.). At this point you can either upgrade your master or you can setup agents to pick up the load. As mentioned above you might also need several different environments to test your builds. In this case using an agent to represent each of your required environments is almost a must.</p><p>An agent is a computer that is set up to offload build projects from the master and once setup this distribution of tasks is fairly automatic. The exact delegation behavior depends on the configuration of each project; some projects may choose to &quot;stick&quot; to a particular machine for a build, while others may choose to roam freely between agents. For people accessing your Jenkins system via the integrated website (<a href="http://yourjenkinsmaster:8080" class="external-link" rel="nofollow">http://yourjenkinsmaster:8080</a>), things work mostly transparently. You can still browse javadoc, see test results, download build results from a master, without ever noticing that builds were done by agents.  In other words, the master becomes a sort of &quot;portal&quot; to the entire build farm.</p><p>Since each agent runs a separate program called an &quot;agent&quot; there is no need to install the full Jenkins (package or compiled binaries) on an agent. There are various ways to start agents, but in the end the agent and Jenkins master need to establish a bi-directional communication link (for example a TCP/IP socket) in order to operate.</p><p>Follow the <a href="Step-by-step-guide-to-set-up-master-and-agent-machines-on-Windows.html">Step by step guide to set up master and agent machines on Windows</a> to quickly start using distributed builds.</p><p><br/></p><h2 id="Distributedbuilds-Mastertoagentconnections">Master to agent connections</h2><p>The most popular ways agents are configured are via connections that are initiated from the master. This allows agents to be minimally configured and the control lives with the master. This does require that the master have network access (ingress) to the agent (typically this is via ssh). In some cases this is not desirable due to security network rules, in which case you can use Agent to master connections via &quot;JNLP&quot;.</p><h2 id="Distributedbuilds-Agenttomasterconnections">Agent to master connections</h2><p>In some cases the agent server will not be visible to the master, so the master can not initiate the agent process. You can use a different type of agent configuration in this case called &quot;JNLP&quot;. This means that the master does not need network &quot;ingress&quot; to the agent (but the agent will need to be able to connect back to the master). Handy for if the agents are behind a firewall, or perhaps in some more secure environment to do trusted deploys (as an example). See the sections below to choose the type of agent that is most appropriate for your needs. </p><h2 id="Distributedbuilds-Choosingwhichagentpipelinesandstepsrunon">Choosing which agent pipelines and steps run on</h2><p>As you will see below, agents can be labelled. This means different part of your build, or pipeline, can be allocated to run in specific agents (based on their label). This can be useful for tools, operating systems or perhaps for security purposes (it is possible to set quite detailed access rules of what can run where, based on agent configurations). A server that runs an agent is often referred to as a &quot;Node&quot; in Jenkins terminology. </p><h1 id="Distributedbuilds-Differentwaysofstartingagents">Different ways of starting agents</h1><p>Pick the right method depending on your environment and OS that master/agents run, or if you want the connection initiated from the master or from the agent end.</p><h2 id="Distributedbuilds-Havemasterlaunchagentviassh">Have master launch agent via ssh</h2><p>Jenkins has a built-in SSH client implementation that it can use to talk to remote sshd and start an agent. This is the most convenient and preferred method for Unix agents, which normally has sshd out-of-the-box. Click Manage Jenkins, then Manage Nodes, then click &quot;New Node.&quot; In this set up, you'll supply the connection information (the agent host name, user name, and ssh credential). Note that the agent will need the master's public ssh key copied to ~/.ssh/authorized_keys. (<a href="http://www.linuxproblem.org/art.html" class="external-link" rel="nofollow">This is a decent howto</a> if you need ssh help). Jenkins will do the rest of the work by itself, including copying the binary needed for an agent, and starting/stopping agents. If your project has external dependencies (like a special ~/.m2/settings.xml, or a special version of java), you'll need to set that up yourself, though.  The <a href="Slave-Setup-Plugin.html">Slave Setup Plugin</a> may be of help.</p><p>This is the most convenient set up on Unix. However, if you are on Windows and you don't have ssh commands with cygwin for example, you can use a tool like PuTTY and PuTTYgen to generate your private and public pair of keys.</p><p>For connecting to Windows agents through cygwin sshd, see <a href="SSH-slaves-and-Cygwin.html">SSH agents and Cygwin</a> for more details.</p><h2 id="Distributedbuilds-HavemasterlaunchagentonWindows">Have master launch agent on Windows</h2><p>For Windows agents, Jenkins can use the remote management facility built into Windows 2000 or later (<a href="http://en.wikipedia.org/wiki/Windows_Management_Instrumentation" class="external-link" rel="nofollow">WMI</a>+<a href="http://en.wikipedia.org/wiki/Distributed_Component_Object_Model" class="external-link" rel="nofollow">DCOM</a>, to be more specific.) In this set up, you'll supply the username and the password of the user who has the administrative access to the system, and Jenkins will use that remotely create a Windows service and remotely start/stop them.</p><p>This is the most convenient set up on Windows, but does not allow you to run programs that require display interaction (such as GUI tests).</p><p><em>Note : Unlike other Node's configuration type, the Node's name is very important as it is taken as the node's address where to create the service !</em></p><h2 id="Distributedbuilds-WriteyourownscripttolaunchJenkinsagents">Write your own script to launch Jenkins agents</h2><p>If the above turn-key solutions do not provide flexibility necessary, you can write your own script to start an agent. You place this script on the master, and tell Jenkins to run this script whenever it needs to connect to an agent.</p><p>Typically, your script uses a remote program execution mechanism like SSH, or other similar means (on Windows, this could be done by the same protocols through <a href="http://www.cygwin.com/" class="external-link" rel="nofollow">cygwin</a> or tools like <a href="http://technet.microsoft.com/en-ca/sysinternals/bb897553.aspx" class="external-link" rel="nofollow">psexec</a>), but Jenkins doesn't really assume any specific method of connectivity.</p><p>What Jenkins expects from your script is that, in the end, it has to execute the agent program like <code>java -jar agent.jar</code>, on the right computer, and have its stdin/stdout connect to your script's stdin/stdout. For example, a script that does &quot;<code>ssh</code> <code><em>mynode</em></code> <code>java -jar ~/bin/agent.jar</code>&quot; would satisfy this.<br/>(The point is that you let Jenkins run this command, as Jenkins uses this stdin/stdout as the communication channel to the agent. Because of this, running this manually from your shell <a href="Launching-slave.jar-from-from-console.html">will do you no good</a>).</p><p>A copy of <code>agent.jar</code> can be downloaded from <code><a href="http://yourserverport" class="external-link" rel="nofollow">http://yourserver:port/jnlpJars/agent.jar</a></code> . Many people write scripts in such a way that this 160K jar is downloaded during the running of said script, to ensure that a consistent version of <code>agent.jar</code> is always used. Such an approach eliminates the agent.jar updating issue discussed below. Note that the <a href="SSH-Slaves-plugin.html">SSH Slaves</a> plugin does this automatically, so agents configured using this plugin always use the correct <code>agent.jar</code>.</p><div class="confluence-information-macro confluence-information-macro-information"><p class="title">Updating slave.jar</p><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Technically speaking, in this set up you should update <code>agent.jar</code> every time you upgrade Jenkins to a new version. However, in practice <code>agent.jar</code> changes infrequently enough that it's also practical not to update until you see a fatal problem in start-up.</p></div></div><p>Launching agents this way often requires an additional initial set up on agents (especially on Windows, where remote login mechanism is not available out of box), but the benefits of this approach is that when the connection goes bad, you can use Jenkins's web interface to re-establish the connection.</p><h2 id="Distributedbuilds-Launchagentvia&quot;JNLP&quot;fromagentbacktomasterinabrowser">Launch agent via &quot;JNLP&quot; from agent back to master in a browser</h2><p>Another way of doing this is to start an agent through Java Web Start (JNLP).</p><p>It requires the server to be configured to appear in first place. So, before attempting to create the build agent, head into manage <em>Jenkins-&gt;Global Security-&gt;TCP port for JNLP agents</em>.</p><p>In this approach, you'll interactively logon to the agent node, open a browser, and open the agent page. You'll be then presented with the JNLP launch icon. Upon clicking it, Java Web Start will kick in, and it launches an agent on the computer where the browser was running.</p><p>This mode is convenient when the master cannot initiate a connection to agents, such as when it runs outside a firewall while the rest of the agents are in the firewall. OTOH, if the machine with an agent goes down, the master has no way of re-launching it on its own.</p><p>On Windows, you can do this manually once, then from the launched JNLP agent, you can <a href="Installing-Jenkins-as-a-Windows-service.html">install it as a Windows service</a> so that you don't need to interactively start the agent from then on.</p><p>If you need display interaction (e.g. for GUI tests) on Windows and you have a dedicated (virtual) test machine, this is a suitable option. Create a jenkins user account, <a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;324737" class="external-link" rel="nofollow">enable auto-login</a>, and put a shortcut to the JNLP file in the Startup items (after having trusted the agent's certificate). This allows one to run tests as a restricted user as well.</p><p>Note: If the master is running behind a reverse proxy or similar, you might need to configure &quot;Tunnel connection through&quot; in the &quot;Advanced&quot; section of the JNLP start method on the agent configuration page to make JNLP work.</p><h2 id="Distributedbuilds-Launchagentheadlesslyfromagentbacktomasteroncommandline">Launch agent headlessly from agent back to master on command line</h2><p>This launch mode uses a mechanism very similar to JNLP as described above, except that it runs without using GUI, making it convenient for an execution as a daemon on Unix. To do this, configure this agent to be a JNLP agent, take <code>agent.jar</code> as discussed above, and then from the agent, run a command like this:</p><div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>$ java -jar agent.jar -jnlpUrl http://yourserver:port/computer/agent-name/slave-agent.jnlp
</pre>
</div></div><p>Make sure to replace &quot;agent-name&quot; with the name of your agent.</p><h2 id="Distributedbuilds-OtherRequirements">Other Requirements</h2><p>Also note that the agents are a kind of a cluster, and operating a cluster (especially a large one or heterogeneous one) is always a non-trivial task. For example, you need to make sure that all agents have JDKs, Ant, CVS, and/or any other tools you need for builds. You need to make sure that agents are up and running, etc. Jenkins is not a clustering middleware, and therefore it doesn't make this any easier.  Nevertheless, one can use <a href="http://en.wikipedia.org/wiki/Provisioning#Server_provisioning" class="external-link" rel="nofollow">a server provisioning tool</a> and <a href="http://en.wikipedia.org/wiki/Comparison_of_open_source_configuration_management_software" class="external-link" rel="nofollow">a configuration management software</a> to facilitate both aspects.</p><h1 id="Distributedbuilds-Nodelabelsforagents">Node labels for agents</h1><p>Labels are tags one can give an agent which allows it to differentiate itself from other nodes in Jenkins.</p><p>A few reasons why node labels are important:</p><ul><li>Nodes might have certain tools associated with it. Labels could include different tools a given node supports.</li><li>Nodes may be in a multi-operating system build environment (e.g. Windows, Mac, and Linux agents within one Jenkins build system). There can be a label for the operating system of the node.</li><li>Nodes may be in geographically different locations which can be the case for multi-datacenter deployments. Jenkins can have agents in different datacenters when inter-datacenter communication is strictly regulated with edge firewalls. In this case, you might have a label for the datacenter or cloudstack in which the agent resides.</li></ul><h2 id="Distributedbuilds-Defininglabels">Defining labels</h2><p>Labels are defined in the settings of static agents and for agent clouds. They must be space separated words which define that agent. Sticking to standard ASCII characters is recommended. Here's a few label suggestions one can use for agent agents:</p><ul><li>For toolchains: <code>jdk</code>, <code>node_js</code>, <code>ruby</code>, etc</li><li>For operating systems: <code>linux</code>, <code>windows</code>, <code>osx</code>; or you can be more detailed like <code>ubuntu16.04</code></li><li>For geographic locations: <code>us-east</code>, <code>japan</code>, <code>eu-central</code> etc</li><li>For platforms: <code>docker</code>, <code>openstack</code>, etc.</li></ul><h2 id="Distributedbuilds-Usinglabels">Using labels</h2><p>Jobs and pipelines can be pinned to specific agents or groups of agents if multiple agents have similar sets of labels. In jobs, visit advanced settings and choose restrict where the job can run. In pipelines, you would restrict it with the <code>node</code> block. You can restrict jobs by specifying a single label or use a label expression. Here's two examples:</p><ul><li>Single label: <code>us-east</code></li><li>Label expression: <code>openstack &amp;&amp; us-east &amp;&amp; linux</code></li></ul><p>The above label expression means that a given agent must have all of those labels.</p><h1 id="Distributedbuilds-Example:ConfigurationonUnix">Example: Configuration on Unix</h1><p>This section describes Kohsuke Kawaguchi's set up of Jenkins agents that he used to use inside Sun for his day job. His master Jenkins node ran on a SPARC Solaris box, and he had many SPARC Solaris agents, Opteron Linux agents, and a few Windows agents.</p><ul><li>Each computer has an user called <code>jenkins</code> and a group called <code>jenkins</code>. All computers use the same UID and GID. (If you have access to NIS, this can be done more easily.) This is not a Jenkins requirement, but it makes the agent management easier.</li><li>On each computer, <code>/var/jenkins</code> directory is set as the home directory of user <code>jenkins</code>. Again, this is not a hard requirement, but having the same directory layout makes things easier to maintain.</li><li>All machines run <code>sshd</code>. Windows agents run <code>cygwin sshd</code>.</li><li>All machines have <code>/usr/sbin/ntpdate</code> installed, and synchronize clock regularly with the same NTP server.</li><li><p>Master's <code>/var/jenkins</code> have all the build tools beneath it --- a few versions of Ant, Maven, and JDKs. JDKs are native programs, so I have JDK copies for all the architectures I need. The directory structure looks like this:</p><div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>/var/jenkins
  +- .ssh
  +- bin
  |   +- agent  (more about this below)
  +- workspace (jenkins creates this file and store all data files inside)
  +- tools
      +- ant-1.5
      +- ant-1.6
      +- maven-1.0.2
      +- maven-2.0
      +- java-1.4 -&gt; native/java-1.4 (symlink)
      +- java-1.5 -&gt; native/java-1.5 (symlink)
      +- java-1.8 -&gt; native/java-1.8 (symlink)
      +- native -&gt; solaris-sparcv9 (symlink; different on each computer)
      +- solaris-sparcv9
      |   +- java-1.4
      |   +- java-1.5
      |   +- java-1.8
      +- linux-amd64
          +- java-1.4
          +- java-1.5
          +- java-1.8</pre>
</div></div></li><li>Master's <code>/var/jenkins/.ssh</code> has private/public key and <code>authorized_keys</code> so that a master can execute programs on agents through <code>ssh</code>, by using <a href="http://www.google.com/search?q=ssh+keygen" class="external-link" rel="nofollow">public key authentication</a>.</li><li>On master, I have a little shell script that uses rsync to synchronize master's <code>/var/jenkins</code> to agents (except <code>/var/jenkins/workspace</code>). I also use the script to replicate tools on all agents.</li><li><p><code>/var/jenkins/bin/launch-agent</code> is a shell script that Jenkins uses to execute jobs remotely. This shell script sets up <code>PATH</code> and a few other things before launching <code>agent.jar.</code> Below is a very simple example script.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">#!/bin/bash

JAVA_HOME=/opt/SUN/jdk1.8.0_152
PATH=$PATH:$JAVA_HOME/bin
export PATH
java -jar /var/jenkins/bin/agent.jar
</pre>
</div></div></li></ul><ul><li>Finally all computers have other standard build tools like <code>svn</code> and <code>cvs</code> installed and available in PATH.</li></ul><p>Note that in the more recent Jenkins packages, the default JENKINS_HOME (aka home directory for the 'jenkins' user on Linux machines, e.g. Red Hat, CentOS, Ubuntu) is set to /var/lib/jenkins.</p><h1 id="Distributedbuilds-Schedulingstrategy">Scheduling strategy</h1><p>Some agents are faster, while others are slow. Some agents are closer (network wise) to a master, others are far away. So doing a good build distribution is a challenge. Currently, Jenkins employs the following strategy:</p><ol><li>If a project is configured to stick to one computer, that's always honored.</li><li>Jenkins tries to build a project on the same computer that it was previously built.</li></ol><p>If you have interesting ideas (or better yet, implementations), please let me know.</p><h1 id="Distributedbuilds-Nodemonitoring">Node monitoring</h1><p>Jenkins has a notion of a <a href="http://javadoc.jenkins-ci.org/hudson/node_monitors/NodeMonitor.html" class="external-link" rel="nofollow">“node monitor”</a> which can check the status of an agent for various conditions, displaying the results and optionally marking the agent offline accordingly. Jenkins bundles several, checking disk space in the workspace; disk space in the temporary partition; swap space; clock skew (compared to the master); and response time.</p><p>Plugins can add other monitors.</p><h1 id="Distributedbuilds-Offlinestatusandretentionstrategy">Offline status and retention strategy</h1><p>Administrators can manually mark agents offline (with an optional published reason) or reconnect them.</p><p>Groovy scripts such as <a href="Monitor-and-Restart-Offline-Slaves.html">Monitor and Restart Offline Slaves</a> can perform batch operations like this. There is also a CLI command to reconnect.</p><p>Then there is a background task which automatically reconnects agents that are thought to be back up. The behavior is configurable per agent (or per cloud, if using cloudy provisioning for agents) via a <a href="http://javadoc.jenkins-ci.org/hudson/slaves/RetentionStrategy.html" class="external-link" rel="nofollow">“retention strategy”</a>, of which Jenkins bundles several (plugins can contribute others): always keep online if possible; drop offline when not in use; use a schedule; behave according to cloud’s notion of load.</p><h1 id="Distributedbuilds-Transitionfrommaster-onlytomaster/agent">Transition from master-only to master/agent</h1><p>Typically, you start with a master-only installation and then much later you add agents as your projects grow. When you enable the master/agent mode, Jenkins automatically configures all your existing projects to stick to the master node. This is a precaution to avoid disturbing existing projects, since most likely you won't be able to configure agents correctly without trial and error. After you configure agents successfully, you need to individually configure projects to let them roam freely. This is tedious, but it allows you to work on one project at a time.</p><p>Projects that are newly created on master/agent-enabled Jenkins will be by default configured to roam freely.</p><h1 id="Distributedbuilds-AccessanInternalCIBuildFarm(Master+Agents)fromthePublicInternet">Access an Internal CI Build Farm (Master + Agents) from the Public Internet</h1><p>One might consider make the Jenkins master accessible on the public network (so that people can see it), while leaving the build agents within the firewall (typical reasons: cost and security) There are several ways to make it work:</p><ul><li>Equip the master node with a network interface that's exposed to the public Internet (simple to do, but not recommended in general)</li><li>Allow port-forwarding from the master to your agents within the firewall. The port-forwarding should be restricted so that only the master with its known IP can connect to agents. With this set up in the firewall, as far as Jenkins is concerned it's as if the firewall doesn't exist.  If multiple hops are involved, you may wish to investigate how to do ssh &quot;jump host&quot; transparently using the ProxyCommand construct.  In fact,  with a properly configured &quot;jump host&quot; setup, even the master doesn't need to expose itself to the public Internet at all - as long as the organization's firewall allows port 22 traffic.</li></ul><ul><li>Use JNLP agents and have agents connect to the master, not the other way around. In this case it's the agents that initiates the connection, so it works correctly with the NAT firewall.</li></ul><p>Note that in both cases, once the master is compromised, all your agents can be easily compromised (IOW, malicious master can execute arbitrary program on agents), so both set-up leaves much to be desired in terms of isolating security breach. <a href="Build-Publisher-Plugin.html">Build Publisher Plugin</a> provides another way of doing this, in more secure fashion.</p><h1 id="Distributedbuilds-RunningMultipleAgentsontheSameMachine">Running Multiple Agents on the Same Machine</h1><p>Using a well established virtualization infrastructure such as <a href="http://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine" class="external-link" rel="nofollow">Kernel-based Virtual Machine (KVM)</a>, it is quite easy to run multiple agent instances on a single physical node.  Such instances can be running various Linux, *BSD UNIX, Solaris, Windows.  For Windows, one can have them installed as separate Windows services so they can start up on system startup. While the correct use of executors largely obviates the need for multiple agent instances on the same machine, there are some unique use cases to consider:</p><ul><li>You want more configurability between the configured nodes. Say you have one node set to be used as much as possible, and the other node to be used only when needed.</li><li>You may have multiple Jenkins master installations building different things, and so this configuration would allow you to have agents for more than one master on the same box. That's right, with Jenkins you really can serve two masters.</li><li>You may wish to leverage the easiness of starting/stopping/replacing virtual machines, perhaps in conjunction with Jenkins plugins such as the <a href="https://wiki.jenkins-ci.org/display/JENKINS/Libvirt+Slaves+Plugin" class="external-link" rel="nofollow">Libvirt Slaves Plugin</a>.</li><li>You wish to maximize your hardware investment and utilization, at the same time minimizing operating cost (e.g. utility expenses for running idling agents).</li></ul><p>Follow these steps to get multiple agents working on the same Windows box:</p><ul><li>Add the first agent node in Jenkins and give it its own working dir (e.g. jenkins-agent-a).</li><li>Go to the agent page from the agent box and launch by JNLP, then use the menu to install it as a service instead.</li><li>Once the service is running, you'll get jenkins-slave.exe and jenkins-slave.xml in your agent's work dir.</li><li>Bring up windows services and stop the Jenkins Slave service.</li><li>Open a shell prompt, cd into the agent work dir.</li><li>First run &quot;jenkins-slave.exe uninstall&quot; to uninstall the one that the jnlp-launched app installed. This should remove it from the service list.</li><li>Now edit jenkins-slave.xml. Modify the id and name values so that your multiple agents are distinct. I called mine jenkins-agent-a and Jenkins Agent A.</li><li>Run jenkins-slave.exe install and then check the Windows service list to ensure it is there. Start it up, and watch Jenkins to see if the agent instance becomes active.</li><li>Now repeat this process for a second agent, beginning with configuring the new node in the master config.</li></ul><p>When you go to create the second node, it is nice to be able to copy an existing node, and copy the first node you setup. Then you just tweak the Remote FS Root and a couple other settings to make it distinct. When you are done you should have two (or more) Jenkins slave services in the list of Windows services.</p><h1 id="Distributedbuilds-Troubleshootingtips">Troubleshooting tips</h1><p>Some interesting pages on issues (and resolutions) occurring when using Windows agents:</p><ul><li><a href="Windows-agents-fail-to-start-via-DCOM.html">Windows agents fail to start via DCOM</a></li><li><a href="Windows-slaves-fail-to-start-via-ssh.html">Windows slaves fail to start via ssh</a></li><li><a href="Windows-slaves-fail-to-start-via-JNLP.html">Windows slaves fail to start via JNLP</a></li></ul><p>Some more general troubleshooting tips:</p><ol><li>Every time Jenkins launches a program locally/remotely, it prints out the command line to the log file. So when a remote execution fails, login to the computer that runs the master by using the same user account, and try to run the command from your shell. You tend to solve problems quickly in this way.</li><li>Each agent has a log page showing the communication between the master and the agent agent. This log often shows error reports.</li><li>If you use binary-unsafe remoting mechanism like telnet to launch an agent, add the <code>-text</code> option to <code>agent.jar</code> so that Jenkins avoids sending binary data over the network.</li><li>When the same command runs outside Jenkins just fine, make sure you are testing it with the same user account as Jenkins runs under. In particular, if you run Jenkins master on Windows, consult <a href="How-to-get-command-prompt-as-the-SYSTEM-user.html">How to get command prompt as the SYSTEM user</a>.</li><li>Feel free to send your trouble to <a href="http://jenkins-ci.org/content/mailing-lists" class="external-link" rel="nofollow">one of our mailing lists</a></li></ol><h2 id="Distributedbuilds-Windowsagentserviceupgrades">Windows agent service upgrades</h2><p>If a newer version of the Jenkins windows service wrapper (jenkins-slave.exe) is available it will be replaced and used on the next start of the service. On very rare occasions the service wrapper may change its behaviour that would require a change in configuration of the service. This can not be done automatically as the service configuration may not be the default and as such could break an installation.</p><p>A quick fix of this is to uninstall the jenkins service then verify the service xml is up-to-date (and contains any site configuration such as the user credentials) and then re-install the service.</p><p>Other manual task that may fix the issue:</p><ul><li>Jenkins &gt; 1.565.1 - a message similar to <code>Restart failure. 'C:\jenkins\jenkins-slave.exe restart' completed with 0 but I'm still alive</code> in the agent error logs. In the windows service manager edit the service configuration to restart the service on failure and add <code>-noReconnect</code> to the agent arguments in the service xml configuration.</li></ul><h1 id="Distributedbuilds-Otherreadings">Other readings</h1><ul><li>Jenkins Build Farm Experience <a href="http://blog.sonatype.com/2009/01/the-hudson-build-farm-experience-volume-i/" class="external-link" rel="nofollow">Volume I</a>, <a href="http://blog.sonatype.com/2009/02/the-hudson-build-farm-experience-volume-ii/" class="external-link" rel="nofollow">Volume 2</a>, <a href="http://www.sonatype.com/people/2009/02/the-hudson-build-farm-experience-volume-iii/" class="external-link" rel="nofollow">Volume 3</a> and <a href="http://www.sonatype.com/people/2009/02/the-hudson-build-farm-experience-volume-iv/" class="external-link" rel="nofollow">Volume 4</a></li><li>HudsonWindowsSlavesSetup<br/><a href="http://community.jboss.org/wiki/HudsonWindowsSlavesSetup" class="external-link" rel="nofollow">http://community.jboss.org/wiki/HudsonWindowsSlavesSetup</a></li></ul>
                    </div>

                    
                 
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Sep 07, 2021 13:08</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
